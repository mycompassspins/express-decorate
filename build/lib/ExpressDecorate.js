"use strict";
const FileSystemHelper_1 = require('./helpers/FileSystemHelper');
const express_1 = require('express');
const util = require('util');
const chalk = require('chalk');
class ExpressDecorate {
    constructor(app, opts) {
        this.app = app;
        this.opts = opts;
        this._setDefaults(app);
        this._loadControllers(app);
    }
    _setDefaults(app) {
        if (!this.opts.hasOwnProperty('extension'))
            this.opts.extension = 'js';
        if (!this.opts.hasOwnProperty('ctrlLoadRecursive'))
            this.opts.ctrlLoadRecursive = true;
        if (this.opts.hasOwnProperty('ctrlIgnore')) {
            this.opts.ctrlIgnore = this.opts.ctrlIgnore instanceof RegExp ?
                this.opts.ctrlIgnore : new RegExp(`${this.opts.ctrlIgnore}`);
        }
        if (!this.opts.hasOwnProperty('mergeParams'))
            this.opts.mergeParams = true;
        if (this.opts.hasOwnProperty('routeConfig'))
            this.opts.routeConfig(app);
        if (!this.opts.hasOwnProperty('debug'))
            this.opts.debug = false;
    }
    _loadControllers(app) {
        const opts = this.opts, EXT_PATTERN = /\.[t|j]s?/, CTRL_PATTERN = /Controller/, MAP_PATTERN = /\.map$/, API_DIR = opts.ctrlDir, IGNORE_PATTERN = opts.ctrlIgnore || null;
        try {
            let apiContents = FileSystemHelper_1.FileSystemHelper.GetDirectoryContents(API_DIR, opts.ctrlLoadRecursive);
            apiContents.filter((file) => {
                return file.fileName.indexOf(opts.extension) !== -1;
            }).forEach((file) => {
                let fileName = file.fileName
                    .replace(EXT_PATTERN, '')
                    .replace('BaseController', '');
                if (CTRL_PATTERN.test(fileName) &&
                    !MAP_PATTERN.test(fileName) &&
                    (!IGNORE_PATTERN || !IGNORE_PATTERN.test(fileName))) {
                    let path = file.fullPath
                        .replace(`${API_DIR}/`, '')
                        .replace(file.fileName, '')
                        .replace(opts.ctrlIgnore, '');
                    try {
                        let ctrlConstructor = require(`${API_DIR}/${path}/${fileName}`), ctrlName = Object.keys(ctrlConstructor)[0], controller = new ctrlConstructor[ctrlName];
                        for (const { method, mountpath, path, middleware, fnName } of controller.$routes) {
                            app.use(mountpath, this._routerAdd(opts, method, mountpath, path, middleware, fnName, controller));
                        }
                        if (opts.debug) {
                            this._constructLogMsg(null, 'debug', opts, `Routes for ${ctrlName}`);
                            controller.$routes.forEach((route) => console.log(util.inspect(route)));
                        }
                    }
                    catch (e) {
                        this._constructLogMsg(e, 'error', this.opts, `configuring routes for ${fileName}:`);
                    }
                }
            });
        }
        catch (e) {
            this._constructLogMsg(e, 'error', this.opts);
        }
    }
    _routerAdd(opts, method, mountpath, path, middleware, fnName, controller) {
        let router = express_1.Router({ mergeParams: opts.mergeParams });
        router[method](path, ...middleware, controller[fnName]);
        return router;
    }
    _constructLogMsg(e, type, opts, customMsg) {
        let chalk = require('chalk'), color = type === 'error' ? 'red' : type === 'debug' ? 'cyan' : 'blue', flag = `[${type.toUpperCase()}] `, msg = customMsg ? `${customMsg}:` : '', error = '';
        if (e)
            error = opts.debug ? e : e.message;
        return console.log(chalk[color](flag), msg, error);
    }
}
exports.ExpressDecorate = ExpressDecorate;

//# sourceMappingURL=data:application/json;base64,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QixFQUFFLFNBQWlCO1FBRTNGLElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFDM0IsS0FBSyxHQUFHLElBQUksS0FBSyxPQUFPLEdBQUcsS0FBSyxHQUFHLElBQUksS0FBSyxPQUFPLEdBQUcsTUFBTSxHQUFHLE1BQU0sRUFDckUsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQ2pDLEdBQUcsR0FBRyxTQUFTLEdBQUcsR0FBRyxTQUFTLEdBQUcsR0FBRyxFQUFFLEVBQ3RDLEtBQUssR0FBTyxFQUFFLENBQUM7UUFFaEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFFMUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwRCxDQUFDO0FBQ0YsQ0FBQztBQTVJWSx1QkFBZSxrQkE0STNCLENBQUEiLCJmaWxlIjoibGliL0V4cHJlc3NEZWNvcmF0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSBKdXN0aW4gb24gOC8yNy8xNi5cbiAqL1xuXG5pbXBvcnQgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbmltcG9ydCB7IEZpbGVTeXN0ZW1IZWxwZXIgYXMgZnNIZWxwZXIgfSBmcm9tICcuL2hlbHBlcnMvRmlsZVN5c3RlbUhlbHBlcidcbmltcG9ydCB7IElFeHByZXNzRGVjb3JhdGVPcHRpb25zIH0gZnJvbSAnLi9pbnRlcmZhY2VzL0lFeHByZXNzRGVjb3JhdGVSZXBvc2l0b3J5J1xuaW1wb3J0IHsgQmFzZUNvbnRyb2xsZXIgfSBmcm9tICcuL2FwaS9CYXNlQ29udHJvbGxlcidcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnXG5cbmNvbnN0IHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG5jb25zdCBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJyk7XG5cbmV4cG9ydCBjbGFzcyBFeHByZXNzRGVjb3JhdGVcbntcblx0Y29uc3RydWN0b3IocHJpdmF0ZSBhcHA6ZXhwcmVzcy5BcHBsaWNhdGlvbiwgcHJpdmF0ZSBvcHRzOklFeHByZXNzRGVjb3JhdGVPcHRpb25zKVxuXHR7XG5cdFx0Ly8gU2V0IG9wdGlvbnMgZGVmYXVsdHNcblx0XHR0aGlzLl9zZXREZWZhdWx0cyhhcHApO1xuXG5cdFx0Ly8gTG9hZCBhbmQgaW5zdGFudGlhdGUgY29udHJvbGxlcnNcblx0XHR0aGlzLl9sb2FkQ29udHJvbGxlcnMoYXBwKTtcblx0fVxuXG5cdHByaXZhdGUgX3NldERlZmF1bHRzKGFwcDpleHByZXNzLkFwcGxpY2F0aW9uKTp2b2lkXG5cdHtcblx0XHRpZiAoIXRoaXMub3B0cy5oYXNPd25Qcm9wZXJ0eSgnZXh0ZW5zaW9uJykpXG5cdFx0XHR0aGlzLm9wdHMuZXh0ZW5zaW9uID0gJ2pzJztcblxuXHRcdGlmICghdGhpcy5vcHRzLmhhc093blByb3BlcnR5KCdjdHJsTG9hZFJlY3Vyc2l2ZScpKVxuXHRcdFx0dGhpcy5vcHRzLmN0cmxMb2FkUmVjdXJzaXZlID0gdHJ1ZTtcblxuXHRcdGlmICh0aGlzLm9wdHMuaGFzT3duUHJvcGVydHkoJ2N0cmxJZ25vcmUnKSlcblx0XHR7XG5cdFx0XHR0aGlzLm9wdHMuY3RybElnbm9yZSA9IHRoaXMub3B0cy5jdHJsSWdub3JlIGluc3RhbmNlb2YgUmVnRXhwID9cblx0XHRcdFx0dGhpcy5vcHRzLmN0cmxJZ25vcmUgOiBuZXcgUmVnRXhwKGAke3RoaXMub3B0cy5jdHJsSWdub3JlfWApO1xuXHRcdH1cblxuXHRcdGlmICghdGhpcy5vcHRzLmhhc093blByb3BlcnR5KCdtZXJnZVBhcmFtcycpKVxuXHRcdFx0dGhpcy5vcHRzLm1lcmdlUGFyYW1zID0gdHJ1ZTtcblxuXHRcdGlmICh0aGlzLm9wdHMuaGFzT3duUHJvcGVydHkoJ3JvdXRlQ29uZmlnJykpXG5cdFx0XHR0aGlzLm9wdHMucm91dGVDb25maWcoYXBwKTtcblxuXHRcdGlmICghdGhpcy5vcHRzLmhhc093blByb3BlcnR5KCdkZWJ1ZycpKVxuXHRcdFx0dGhpcy5vcHRzLmRlYnVnID0gZmFsc2U7XG5cdH1cblxuXHQvKipcblx0ICogTG9hZCBhbmQgaW5zdGFudGlhdGUgQVBJIGNvbnRyb2xsZXJzIGFuZCBjb25maWd1cmUgcm91dGVzIGZvciBlYWNoXG5cdCAqIEBwYXJhbSBhcHBcblx0ICogQHJldHVybnMge3ZvaWR9XG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIF9sb2FkQ29udHJvbGxlcnMoYXBwOmFueSk6dm9pZFxuXHR7XG5cdFx0Y29uc3Qgb3B0cyA9IHRoaXMub3B0cyxcblx0XHRcdEVYVF9QQVRURVJOOlJlZ0V4cCA9IC9cXC5bdHxqXXM/Lyxcblx0XHRcdENUUkxfUEFUVEVSTjpSZWdFeHAgPSAvQ29udHJvbGxlci8sXG5cdFx0XHRNQVBfUEFUVEVSTjpSZWdFeHAgPSAvXFwubWFwJC8sXG5cdFx0XHRBUElfRElSOnN0cmluZyA9IG9wdHMuY3RybERpcixcblx0XHRcdElHTk9SRV9QQVRURVJOOlJlZ0V4cCA9IG9wdHMuY3RybElnbm9yZSB8fCBudWxsO1xuXG5cdFx0dHJ5XG5cdFx0e1xuXHRcdFx0Ly8gR2V0IGxpc3Qgb2YgZmlsZXMgaW4gY29udHJvbGxlcnMgZGlyZWN0b3J5XG5cdFx0XHRsZXQgYXBpQ29udGVudHM6c3RyaW5nW10gPSBmc0hlbHBlci5HZXREaXJlY3RvcnlDb250ZW50cyhBUElfRElSLCBvcHRzLmN0cmxMb2FkUmVjdXJzaXZlKTtcblxuXHRcdFx0YXBpQ29udGVudHMuZmlsdGVyKChmaWxlOmFueSkgPT5cblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIGZpbGUuZmlsZU5hbWUuaW5kZXhPZihvcHRzLmV4dGVuc2lvbikgIT09IC0xO1xuXHRcdFx0fSkuZm9yRWFjaCgoZmlsZTphbnkpID0+XG5cdFx0XHR7XG5cdFx0XHRcdC8vIEdldCBmaWxlIG5hbWUgd2l0aG91dCBleHRlbnNpb24gYW5kIG1ha2Ugc3VyZSBCYXNlQ29udHJvbGxlciBpcyBza2lwcGVkXG5cdFx0XHRcdGxldCBmaWxlTmFtZTpzdHJpbmcgPSBmaWxlLmZpbGVOYW1lXG5cdFx0XHRcdFx0LnJlcGxhY2UoRVhUX1BBVFRFUk4sICcnKVxuXHRcdFx0XHRcdC5yZXBsYWNlKCdCYXNlQ29udHJvbGxlcicsICcnKTtcblxuXHRcdFx0XHQvLyBJZiB0aGUgZmlsZSBpcyBhIENvbnRyb2xsZXIgYW5kIG5vdCBhIC5tYXAgZmlsZVxuXHRcdFx0XHRpZiAoXG5cdFx0XHRcdFx0Q1RSTF9QQVRURVJOLnRlc3QoZmlsZU5hbWUpICYmXG5cdFx0XHRcdFx0IU1BUF9QQVRURVJOLnRlc3QoZmlsZU5hbWUpICYmXG5cdFx0XHRcdFx0KCFJR05PUkVfUEFUVEVSTiB8fCAhSUdOT1JFX1BBVFRFUk4udGVzdChmaWxlTmFtZSkpXG5cdFx0XHRcdClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdC8vIENvbnN0cnVjdCByZWxhdGl2ZSBwYXRoIGZvciByZXF1aXJlKCkgY2FsbFxuXHRcdFx0XHRcdGxldCBwYXRoID0gZmlsZS5mdWxsUGF0aFxuXHRcdFx0XHRcdFx0LnJlcGxhY2UoYCR7QVBJX0RJUn0vYCwgJycpXG5cdFx0XHRcdFx0XHQucmVwbGFjZShmaWxlLmZpbGVOYW1lLCAnJylcblx0XHRcdFx0XHRcdC5yZXBsYWNlKG9wdHMuY3RybElnbm9yZSwgJycpO1xuXG5cdFx0XHRcdFx0dHJ5XG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0Ly8gSW5zdGFudGlhdGUgdGhlIGNvbnRyb2xsZXJcblx0XHRcdFx0XHRcdGxldFx0Y3RybENvbnN0cnVjdG9yOmFueSA9IHJlcXVpcmUoYCR7QVBJX0RJUn0vJHtwYXRofS8ke2ZpbGVOYW1lfWApLFxuXHRcdFx0XHRcdFx0XHRjdHJsTmFtZTpzdHJpbmcgPSBPYmplY3Qua2V5cyhjdHJsQ29uc3RydWN0b3IpWzBdLFxuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyOkJhc2VDb250cm9sbGVyID0gbmV3IGN0cmxDb25zdHJ1Y3RvcltjdHJsTmFtZV07XG5cblx0XHRcdFx0XHRcdC8vICRyb3V0ZXMgcHJvcGVydHkgaXMgYWRkZWQgdG8gZWFjaCBjb250cm9sbGVyIHZpYSB0aGUgRW5kUG9pbnRSb3V0aW5nIGRlY29yYXRvcnNcblx0XHRcdFx0XHRcdC8vIExvb3AgdGhlICRyb3V0ZXMgYW5kIGF0dGFjaCBlYWNoIHRvIHRoZSBwcm9wZXIgY29udHJvbGxlciBhY3Rpb25cblx0XHRcdFx0XHRcdGZvciAoY29uc3QgeyBtZXRob2QsIG1vdW50cGF0aCwgcGF0aCwgbWlkZGxld2FyZSwgZm5OYW1lIH0gb2YgY29udHJvbGxlci4kcm91dGVzKVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHQvLyBTZXQgdGhlIG1vdW50cGF0aCBmb3IgRXhwcmVzc1xuXHRcdFx0XHRcdFx0XHRhcHAudXNlKFxuXHRcdFx0XHRcdFx0XHRcdG1vdW50cGF0aCxcblx0XHRcdFx0XHRcdFx0XHR0aGlzLl9yb3V0ZXJBZGQob3B0cywgbWV0aG9kLCBtb3VudHBhdGgsIHBhdGgsIG1pZGRsZXdhcmUsIGZuTmFtZSwgY29udHJvbGxlcilcblx0XHRcdFx0XHRcdFx0KTtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0Ly8gREVCVUc6IGxvZyBjb250cm9sbGVyIHJvdXRlc1xuXHRcdFx0XHRcdFx0aWYgKG9wdHMuZGVidWcpXG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdHRoaXMuX2NvbnN0cnVjdExvZ01zZyhudWxsLCAnZGVidWcnLCBvcHRzLCBgUm91dGVzIGZvciAke2N0cmxOYW1lfWApO1xuXHRcdFx0XHRcdFx0XHRjb250cm9sbGVyLiRyb3V0ZXMuZm9yRWFjaCgocm91dGU6YW55KSA9PiBjb25zb2xlLmxvZyh1dGlsLmluc3BlY3Qocm91dGUpKSk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGNhdGNoKGUpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0dGhpcy5fY29uc3RydWN0TG9nTXNnKGUsICdlcnJvcicsIHRoaXMub3B0cywgYGNvbmZpZ3VyaW5nIHJvdXRlcyBmb3IgJHtmaWxlTmFtZX06YCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9XG5cdFx0Y2F0Y2goZSlcblx0XHR7XG5cdFx0XHR0aGlzLl9jb25zdHJ1Y3RMb2dNc2coZSwgJ2Vycm9yJywgdGhpcy5vcHRzKTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIF9yb3V0ZXJBZGQob3B0czpJRXhwcmVzc0RlY29yYXRlT3B0aW9ucywgbWV0aG9kOnN0cmluZywgbW91bnRwYXRoOnN0cmluZywgcGF0aDpzdHJpbmcsXG5cdFx0XHRcdFx0ICAgbWlkZGxld2FyZTphbnlbXSwgZm5OYW1lOnN0cmluZywgY29udHJvbGxlcjphbnkpOlJvdXRlclxuXHR7XG5cdFx0Ly8gbWVyZ2VQYXJhbXMgYWxsb3dzIHVzIHRvIGhhdmUgYSBwYXRoIHBhcmFtZXRlciBpbiB0aGUgbW91bnRwYXRoIHRoYXQgd2lsbCB0aGVuIHNob3dcblx0XHQvLyBpbiB0aGUgRXhwcmVzcyByZXF1ZXN0IG9iamVjdCB2aWEgcmVxLnBhcmFtc1xuXHRcdGxldCByb3V0ZXI6YW55ID0gUm91dGVyKHsgbWVyZ2VQYXJhbXM6IG9wdHMubWVyZ2VQYXJhbXMgfSk7XG5cblx0XHQvLyBBdHRhY2ggcm91dGVyLCBtaWRkbGV3YXJlIGFuZCBjb250cm9sbGVyIGFjdGlvbiB0byBtb3VudHBhdGhcblx0XHRyb3V0ZXJbbWV0aG9kXShwYXRoLCAuLi5taWRkbGV3YXJlLCBjb250cm9sbGVyW2ZuTmFtZV0pO1xuXHRcdHJldHVybiByb3V0ZXI7XG5cdH1cblxuXHRwcml2YXRlIF9jb25zdHJ1Y3RMb2dNc2coZTphbnksIHR5cGU6c3RyaW5nLCBvcHRzOklFeHByZXNzRGVjb3JhdGVPcHRpb25zLCBjdXN0b21Nc2c/OnN0cmluZyk6YW55XG5cdHtcblx0XHRsZXQgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpLFxuXHRcdFx0Y29sb3IgPSB0eXBlID09PSAnZXJyb3InID8gJ3JlZCcgOiB0eXBlID09PSAnZGVidWcnID8gJ2N5YW4nIDogJ2JsdWUnLFxuXHRcdFx0ZmxhZyA9IGBbJHt0eXBlLnRvVXBwZXJDYXNlKCl9XSBgLFxuXHRcdFx0bXNnID0gY3VzdG9tTXNnID8gYCR7Y3VzdG9tTXNnfTpgIDogJycsXG5cdFx0XHRlcnJvcjphbnkgPSAnJztcblxuXHRcdGlmIChlKSBlcnJvciA9IG9wdHMuZGVidWcgPyBlIDogZS5tZXNzYWdlO1xuXG5cdFx0cmV0dXJuIGNvbnNvbGUubG9nKGNoYWxrW2NvbG9yXShmbGFnKSwgbXNnLCBlcnJvcik7XG5cdH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
